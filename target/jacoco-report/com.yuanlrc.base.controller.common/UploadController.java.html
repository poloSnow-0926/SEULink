<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">chatonline</a> &gt; <a href="index.source.html" class="el_package">com.yuanlrc.base.controller.common</a> &gt; <span class="el_source">UploadController.java</span></div><h1>UploadController.java</h1><pre class="source lang-java linenums">package com.yuanlrc.base.controller.common;

import java.io.File;
import java.io.IOException;
import java.util.Date;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import com.yuanlrc.base.bean.CodeMsg;
import com.yuanlrc.base.bean.Result;
import com.yuanlrc.base.util.StringUtil;

/**
 * 公用的上传类
 * @author Administrator
 *
 */
@RequestMapping(&quot;/upload&quot;)
@Controller
<span class="nc" id="L28">public class UploadController {</span>

	@Value(&quot;${ylrc.upload.photo.sufix}&quot;)
	private String uploadPhotoSufix;
	
	@Value(&quot;${ylrc.upload.photo.maxsize}&quot;)
	private long uploadPhotoMaxSize;
	
	@Value(&quot;${ylrc.upload.photo.path}&quot;)
	private String uploadPhotoPath;//图片保存位置
	
	@Value(&quot;${ylrc.upload.file.maxsize}&quot;)
	private long uploadFileMaxSize;
	
	@Value(&quot;${ylrc.upload.file.path}&quot;)
	private String uploadFilePath;//文件保存位置
	
<span class="nc" id="L45">	private Logger log = LoggerFactory.getLogger(UploadController.class);</span>
	
	/**
	 * 图片统一上传类
	 * @param photo
	 * @return
	 */
	@RequestMapping(value=&quot;/upload_photo&quot;,method=RequestMethod.POST)
	@ResponseBody
	public Result&lt;String&gt; uploadPhoto(@RequestParam(name=&quot;photo&quot;,required=true)MultipartFile photo){
		//判断文件类型是否是图片
<span class="nc" id="L56">		String originalFilename = photo.getOriginalFilename();</span>
		//获取文件后缀
<span class="nc" id="L58">		String suffix = originalFilename.substring(originalFilename.lastIndexOf(&quot;.&quot;),originalFilename.length());</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if(!uploadPhotoSufix.contains(suffix.toLowerCase())){</span>
<span class="nc" id="L60">			return Result.error(CodeMsg.UPLOAD_PHOTO_SUFFIX_ERROR);</span>
		}
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if(photo.getSize()/1024 &gt; uploadPhotoMaxSize){</span>
<span class="nc" id="L63">			CodeMsg codeMsg = CodeMsg.UPLOAD_PHOTO_ERROR;</span>
<span class="nc" id="L64">			codeMsg.setMsg(&quot;图片大小不能超过&quot; + (uploadPhotoMaxSize/1024) + &quot;M&quot;);</span>
<span class="nc" id="L65">			return Result.error(codeMsg);</span>
		}
		//准备保存文件
<span class="nc" id="L68">		File filePath = new File(uploadPhotoPath);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">		if(!filePath.exists()){</span>
			//若不存在文件夹，则创建一个文件夹
<span class="nc" id="L71">			filePath.mkdir();</span>
		}
<span class="nc" id="L73">		filePath = new File(uploadPhotoPath + &quot;/&quot; + StringUtil.getFormatterDate(new Date(), &quot;yyyyMMdd&quot;));</span>
		//判断当天日期的文件夹是否存在，若不存在，则创建
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if(!filePath.exists()){</span>
			//若不存在文件夹，则创建一个文件夹
<span class="nc" id="L77">			filePath.mkdir();</span>
		}
<span class="nc" id="L79">		String filename = StringUtil.getFormatterDate(new Date(), &quot;yyyyMMdd&quot;) + &quot;/&quot; + System.currentTimeMillis() + suffix;</span>
		try {
<span class="nc" id="L81">			photo.transferTo(new File(uploadPhotoPath+&quot;/&quot;+filename));</span>
<span class="nc" id="L82">		} catch (IllegalStateException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L84">			e.printStackTrace();</span>
<span class="nc" id="L85">		} catch (IOException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L87">			e.printStackTrace();</span>
<span class="nc" id="L88">		}</span>
<span class="nc" id="L89">		log.info(&quot;图片上传成功，保存位置：&quot; + uploadPhotoPath + filename);</span>
<span class="nc" id="L90">		return Result.success(filename);</span>
	}
	
	/**
	 * 文件统一上传类
	 * @param file
	 * @return
	 */
	@RequestMapping(value=&quot;/upload_file&quot;,method=RequestMethod.POST)
	@ResponseBody
	public Result&lt;String&gt; uploadFile(@RequestParam(name=&quot;file&quot;,required=true)MultipartFile file){
		//判断文件类型是否是图片
<span class="nc" id="L102">		String originalFilename = file.getOriginalFilename();</span>
		//获取文件后缀
<span class="nc" id="L104">		String suffix = originalFilename.substring(originalFilename.lastIndexOf(&quot;.&quot;),originalFilename.length());</span>
//		if(!uploadPhotoSufix.contains(suffix.toLowerCase())){
//			return Result.error(CodeMsg.UPLOAD_PHOTO_SUFFIX_ERROR);
//		}
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if(file.getSize()/1024 &gt; uploadFileMaxSize){</span>
<span class="nc" id="L109">			CodeMsg codeMsg = CodeMsg.UPLOAD_PHOTO_ERROR;</span>
<span class="nc" id="L110">			codeMsg.setMsg(&quot;文件大小不能超过&quot; + (uploadFileMaxSize/1024) + &quot;M&quot;);</span>
<span class="nc" id="L111">			return Result.error(codeMsg);</span>
		}
		//准备保存文件
<span class="nc" id="L114">		File filePath = new File(uploadFilePath);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		if(!filePath.exists()){</span>
			//若不存在文件夹，则创建一个文件夹
<span class="nc" id="L117">			filePath.mkdir();</span>
		}
<span class="nc" id="L119">		filePath = new File(uploadFilePath + &quot;/&quot; + StringUtil.getFormatterDate(new Date(), &quot;yyyyMMdd&quot;));</span>
		//判断当天日期的文件夹是否存在，若不存在，则创建
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if(!filePath.exists()){</span>
			//若不存在文件夹，则创建一个文件夹
<span class="nc" id="L123">			filePath.mkdir();</span>
		}
<span class="nc" id="L125">		String filename = StringUtil.getFormatterDate(new Date(), &quot;yyyyMMdd&quot;) + &quot;/&quot; + System.currentTimeMillis() + suffix;</span>
		try {
<span class="nc" id="L127">			file.transferTo(new File(uploadFilePath+&quot;/&quot;+filename));</span>
<span class="nc" id="L128">		} catch (IllegalStateException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L130">			e.printStackTrace();</span>
<span class="nc" id="L131">		} catch (IOException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L133">			e.printStackTrace();</span>
<span class="nc" id="L134">		}</span>
<span class="nc" id="L135">		log.info(&quot;文件上传成功，保存位置：&quot; + uploadFilePath + filename);</span>
<span class="nc" id="L136">		return Result.success(filename);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>